name: Update Changelog

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-changelog:
    name: Generate AI Changelog
    runs-on: ubuntu-latest
    if: github.event.release.draft == false && github.event.release.prerelease == false

    steps:
      - name: Validate API key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "::error::OPENAI_API_KEY secret is not configured. This is required for changelog generation."
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate changelog with AI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          npx @nyaomaru/changelog-bot@latest \
            --release-tag "${{ github.event.release.tag_name }}" \
            --release-name "${{ github.event.release.tag_name }}" \
            --release-body "${{ github.event.release.body }}" \
            --changelog-path CHANGELOG.md \
            --provider openai

      - name: Commit and push CHANGELOG.md
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No changes to CHANGELOG.md"
            exit 0
          fi

          git commit -m "docs: update CHANGELOG.md for ${{ github.event.release.tag_name }} [skip ci]"
          git push origin HEAD:main

      - name: Extract changelog entry for release notes
        id: extract
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"

          ENTRY=$(awk "/^## \\[${VERSION}\\]/{found=1; next} /^## \\[/{if(found) exit} found{print}" CHANGELOG.md)

          if [ -z "$ENTRY" ]; then
            ENTRY=$(awk "/^## ${TAG}/{found=1; next} /^## /{if(found) exit} found{print}" CHANGELOG.md)
          fi

          {
            echo "entry<<ENTRY_EOF"
            echo "$ENTRY"
            echo "ENTRY_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Update release notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGELOG_ENTRY: ${{ steps.extract.outputs.entry }}
        run: |
          TAG="${{ github.event.release.tag_name }}"

          CURRENT_BODY=$(gh release view "$TAG" --json body --jq '.body')

          PLACEHOLDER='> **Detailed AI-generated changelog is being generated and will appear here shortly...**'

          python3 -c "
          import os, re

          body = os.environ['CURRENT_BODY']
          entry = os.environ['CHANGELOG_ENTRY']
          placeholder = os.environ['PLACEHOLDER']

          section = '### What'\''s Changed\n\n' + entry

          pattern = r'---\s*\n\s*' + re.escape(placeholder) + r'\s*\n\s*---'
          new_body, count = re.subn(pattern, section, body)

          if count == 0:
              new_body = body + '\n\n' + section

          with open('/tmp/release-body.txt', 'w') as f:
              f.write(new_body)
          "

          gh release edit "$TAG" --notes-file /tmp/release-body.txt
          echo "Updated release notes for $TAG"
